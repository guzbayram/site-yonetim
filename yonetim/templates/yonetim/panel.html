{% load humanize %}
<!DOCTYPE html>
<html lang="tr">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Panel - {{ site.ad }}</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <style>
      :root {
        --theme-primary-purple: #6a0dad; /* Ana tema rengi (giriş sayfasındaki mor) */
        --theme-dark-purple: #540a8c;    /* Koyu mor (hover vb. için) */
        --theme-light-purple-accent: #8344c2; /* Açık mor vurgu */
        --theme-very-light-purple-bg: #f5efff; /* Çok açık mor (arka planlar için) */
        --theme-light-purple-border: #d1b0e8; /* Açık mor kenarlık */
        --theme-neutral-gray: #adb5bd; /* Nötr gri */
        --theme-dark-gray: #6c757d; /* Koyu Gri */
      }

      body {
        background: var(--theme-primary-purple); /* Ana sayfa arka planı mor */
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        min-height: 100vh;
        display: flex;
        flex-direction: column;
        justify-content: center; /* Dikeyde ortala */
        align-items: center; /* Yatayda ortala */
        padding-top: 20px; /* Toast mesajı için biraz boşluk */
        padding-bottom: 20px;
      }
      .panel-container {
        max-width: 1300px;
        width: calc(100% - 40px); /* Kenarlardan boşluklu tam genişlik */
        margin: 0 auto;
        background: #fff; /* Panel ana içeriği beyaz */
        border-radius: 12px; /* Daha yuvarlak köşeler */
        box-shadow: 0 5px 20px rgba(0, 0, 0, 0.2); /* Daha belirgin gölge */
        padding: 25px;
      }
      .side-bar {
        background: #ffffff; /* Kenar çubuğu beyaz kalacak */
        border-radius: 8px;
        padding: 20px;
        /* box-shadow: 0 1px 5px rgba(0,0,0,0.05); /* İç gölgeye gerek yok, panel-container'da var */
        margin-bottom: 20px;
      }
      .site-title {
        font-weight: 700; /* Daha kalın */
        color: var(--theme-dark-purple); /* Koyu mor site başlığı */
        text-align: center;
        margin-bottom: 20px;
        font-size: 1.6rem; /* Biraz daha büyük */
        border-bottom: 2px solid var(--theme-light-purple-border); /* Mor alt çizgi */
        padding-bottom: 15px;
      }
      .table thead {
        /* Bu genel kural, HTML'deki inline style'ı geçersiz kılmayabilir.
           HTML'deki thead etiketinin style attribute'ündeki background'u değiştirmeniz önerilir.
           Veya aşağıdaki gibi daha spesifik bir seçici kullanabilirsiniz.
        */
        background: var(--theme-primary-purple) !important; /* Tablo başlığı mor - !important gerekebilir */
        color: #fff;
      }
      /* HTML'deki inline style'ı değiştiremiyorsanız:
      table > thead[style*="sticky"] {
          background-color: var(--theme-primary-purple) !important;
      }
      */
      .summary-card {
        background-color: #fff; /* Özet kartları beyaz (panel-container üzerinde) */
        padding: 20px; /* İç boşluk artırıldı */
        border-radius: 8px; /* Köşeler yuvarlatıldı */
        margin-bottom: 15px;
        text-align: center;
        border: 1px solid var(--theme-light-purple-border); /* Hafif mor kenarlık */
      }
      .summary-card .value {
        font-size: 1.6rem; /* Değerler biraz daha büyük */
        font-weight: bold;
        color: #28a745; /* Pozitif değerler yeşil kalabilir */
      }
      .summary-card .value.negative {
        color: #dc3545; /* Negatif değerler kırmızı kalabilir */
      }
      .summary-card .label {
        font-size: 0.9rem;
        color: var(--theme-primary-purple); /* Etiketler mor */
        margin-top: 5px;
      }
      .form-section {
        margin-bottom: 25px;
        padding: 20px;
        background-color: #fff; /* Form bölümü beyaz */
        border: 1px solid var(--theme-light-purple-border); /* Mor kenarlık */
        border-radius: 8px;
      }
      .form-section .form-label {
        font-weight: 600; /* Label'lar biraz daha kalın */
        color: var(--theme-dark-purple);
      }
      .user-info {
        padding: 20px;
        background-color: var(--theme-very-light-purple-bg); /* Çok açık mor arka plan */
        border-radius: 8px;
        margin-bottom: 20px;
        color: var(--theme-dark-purple); /* Metin rengi */
      }
      .user-info strong {
        color: var(--theme-primary-purple); /* Vurgulu metinler ana mor */
      }
      .user-info hr {
        border-top: 1px solid var(--theme-light-purple-border);
        opacity: 0.5;
      }
      .nav-pills .nav-link {
        color: var(--theme-primary-purple); /* Navigasyon linkleri mor */
        font-weight: 500;
      }
      .nav-pills .nav-link.active {
        background-color: var(--theme-primary-purple); /* Aktif link arka planı mor */
        color: white;
        box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      }
      .table-responsive {
        max-height: 520px;
        overflow-y: auto;
        border: 1px solid #dee2e6; /* Tablolara genel bir çerçeve */
        border-radius: 5px;
      }
      /* Toast mesajı */
      #toast-message {
        position: fixed; /* Sayfa scroll olsa bile sabit kalsın */
        left: 50%;
        transform: translateX(-50%);
        z-index: 1056; /* Bootstrap modal'larının üzerinde (varsa) */
        min-width: 300px;
        max-width: 90vw;
        pointer-events: none; /* Arkasındaki elemanlara tıklanabilsin diye */
        top: 20px; /* Sayfanın üstünden boşluk */
      }
      #toast-message .toast {
          pointer-events: all; /* Toast'ın kendisine tıklanabilsin */
      }
      /* Bootstrap text-bg-primary toast'ını mor yapmak için (eğer message.tags 'primary' ise) */
      #toast-message .toast.text-bg-primary {
        background-color: var(--theme-primary-purple) !important;
        color: white !important;
      }
      .table-responsive.equal-height {
        min-height: 350px;
        max-height: 520px;
        overflow-y: auto;
      }
      .table.equal-cols {
        table-layout: auto !important;
        width: 100%;
      }

      /* Buton Stilleri */
      .btn-success, .btn-success:focus {
        background-color: var(--theme-primary-purple) !important; /* !important Bootstrap'ı geçmek için */
        border-color: var(--theme-primary-purple) !important;
        color: white;
      }
      .btn-success:hover {
        background-color: var(--theme-dark-purple) !important;
        border-color: var(--theme-dark-purple) !important;
        color: white;
      }

      .btn-info, .btn-info:focus {
        background-color: var(--theme-light-purple-accent) !important;
        border-color: var(--theme-light-purple-accent) !important;
        color: white;
      }
      .btn-info:hover {
        background-color: var(--theme-primary-purple) !important;
        border-color: var(--theme-primary-purple) !important;
        color: white;
      }

      .btn-secondary, .btn-secondary:focus {
        background-color: var(--theme-neutral-gray) !important;
        border-color: var(--theme-neutral-gray) !important;
        color: white;
      }
      .btn-secondary:hover {
        background-color: var(--theme-dark-gray) !important; /* Bootstrap'ın .btn-secondary hover rengi */
        border-color: var(--theme-dark-gray) !important;
        color: white;
      }
      /* Diğer butonlar (örn: .btn-danger) Bootstrap varsayılanlarını kullanabilir veya benzer şekilde tema rengine uyarlanabilir. */
    </style>
  </head>

  <body>
    <div class="container panel-container">
      {% if messages %}
      <div id="toast-message">
        {% for message in messages %}
        <div
          class="toast align-items-center text-bg-{{ message.tags }} border-0 show"
          role="alert"
          aria-live="assertive"
          aria-atomic="true"
          style="opacity: 0.97; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15)"
        >
          <div class="d-flex">
            <div class="toast-body w-100 text-center fw-semibold">{{ message }}</div> {# fw-semibold eklendi #}
          </div>
        </div>
        {% endfor %}
      </div>
      <script>
        setTimeout(function () {
          var toastContainer = document.getElementById("toast-message");
          if (toastContainer) {
            var toasts = toastContainer.querySelectorAll('.toast');
            toasts.forEach(function(toast) {
              var bsToast = new bootstrap.Toast(toast, { delay: 3000 }); // Bootstrap Toast'ı ile gizle
              bsToast.hide();
              // Gizlendikten sonra DOM'dan kaldırmak için
              toast.addEventListener('hidden.bs.toast', function () {
                toast.remove();
                if (toastContainer.childElementCount === 0) {
                    // toastContainer.style.display = 'none'; // Veya container'ı kaldır
                }
              });
            });
          }
        }, 3000);
      </script>
      {% endif %}

      <div class="row">
        <div class="col-lg-4 side-bar">
          <div class="site-title">{{ site.ad }}</div>

          <div class="user-info">
            Hoş geldiniz,
            <strong>
              {{ request.user.first_name }} {{ request.user.last_name }}
            </strong>
            {% if kullanici_blok_adi != "-" %}
            <br />Blok: {{ kullanici_blok_adi }} <br />Daire No: 
            {{ kullanici_daire_no }} {% elif request.user.is_yonetici %}
            <br /><span class="text-muted">
              (Yönetici - Henüz daire seçilmedi)</span
            >
            {% endif %}
            <hr />
            Site Aylık Aidat:
            <strong>{{ site_aylik_aidat|floatformat:2|intcomma }} ₺</strong>
            <br />
            Toplam Ödediğiniz Aidat: <strong>{{ kullanici_odenmis_aidat_toplami|floatformat:2|intcomma }} ₺</strong>
          </div>

          {% if kullanici_daireler.exists or request.user.is_yonetici %}
          <div class="form-section">
            <h5>Aidat İşlemi</h5>
            <form method="post">
              {% csrf_token %} {% if request.user.is_yonetici %}
              <div class="mb-3">
                <label for="daire_id_form" class="form-label"
                  >Daire Seçin (Yönetici)</label
                >
                <select
                  name="daire_id_form"
                  id="daire_id_form"
                  class="form-select"
                  required
                >
                  <option value="">---------</option>
                  {% for d in daireler %}
                  <option value="{{ d.id }}">
                    {{ d.blok.ad }} - {{ d.no }} {% if d.kullanici%}
                    ({{d.kullanici.first_name}} {{d.kullanici.last_name}})
                    {%else %}(Boş){% endif %}
                  </option>
                  {% endfor %}
                </select>
              </div>
              {% elif kullanici_daireler.exists %}
              <input
                type="hidden"
                name="daire_id_form"
                value="{{ kullanici_daireler.first.id }}"
              />
              <p class="mb-2"> {# Alt boşluk azaltıldı #}
                <strong>{{kullanici_blok_adi}} - {{kullanici_daire_no}}</strong>
                için aidat ödemesi:
              </p>
              {% endif %}
              <div class="mb-3">
                <label for="odeme_miktari" class="form-label"
                  >Ödeme Miktarı (₺)</label
                >
                <input
                  type="number"
                  class="form-control"
                  name="odeme_miktari"
                  id="odeme_miktari"
                  placeholder="Örn: {{ site_aylik_aidat|floatformat:0 }}"
                  step="0.01"
                  required
                />
              </div>
              <div class="mb-3">
                <label for="odeme_aciklama" class="form-label"
                  >Açıklama (Opsiyonel)</label
                >
                <input
                  type="text"
                  class="form-control"
                  name="odeme_aciklama"
                  id="odeme_aciklama"
                  placeholder="Örn: Mayıs Ayı Aidatı"
                />
              </div>
              <button type="submit" name="aidat_kaydet" class="btn btn-success w-100"> {# name eklendi ayırt etmek için #}
                AİDAT KAYDET
              </button>
            </form>
          </div>
          {% endif %} {% if request.user.is_yonetici %}
          <div class="form-section">
            <h5>Gider Ekleme</h5>
            <form method="post">
              {% csrf_token %}
              <div class="mb-3">
                <label for="gider_turu" class="form-label">Gider Türü</label>
                <input
                  type="text"
                  class="form-control"
                  name="gider_turu"
                  id="gider_turu"
                  placeholder="Örn: Elektrik Faturası"
                  required
                />
              </div>
              <div class="mb-3">
                <label for="gider_miktari" class="form-label"
                  >Gider Miktarı (₺)</label
                >
                <input
                  type="number"
                  class="form-control"
                  name="gider_miktari"
                  id="gider_miktari"
                  placeholder="Örn: 150.75"
                  step="0.01"
                  required
                />
              </div>
              <div class="mb-3">
                <label for="gider_aciklama" class="form-label"
                  >Açıklama (Opsiyonel)</label
                >
                <input
                  type="text"
                  class="form-control"
                  name="gider_aciklama"
                  id="gider_aciklama"
                />
              </div>
              <button type="submit" name="gider_kaydet" class="btn btn-danger w-100"> {# name eklendi ayırt etmek için #}
                GİDER KAYDET
              </button>
            </form>
          </div>
          {% endif %}

          <hr style="border-top-color: var(--theme-light-purple-border); opacity: 0.5;" /> {# hr stil eklendi #}
          {% if request.user.is_yonetici %}
          <a
            href="{% url 'yonetim:site_bilgi' %}"
            class="btn btn-info w-100 mb-2"
            >Site Bilgilerini Düzenle</a
          >
          {% endif %}
          <a href="{% url 'yonetim:cikis' %}" class="btn btn-secondary w-100"
            >Çıkış Yap</a
          >
        </div>

        <div class="col-lg-8">
          <div class="row text-center mb-4">
            <div class="col-md-4">
              <div class="summary-card">
                <div class="value">
                  {{ toplam_gelir|floatformat:2|intcomma }} ₺
                </div>
                <div class="label">Toplam Gelir (Aidatlar)</div>
              </div>
            </div>
            <div class="col-md-4">
              <div class="summary-card">
                <div class="value negative">
                  {{ toplam_gider|floatformat:2|intcomma }} ₺
                </div>
                <div class="label">Toplam Gider</div>
              </div>
            </div>
            <div class="col-md-4">
              <div class="summary-card">
                <div
                  class="value {% if kasa_bakiyesi < 0 %}negative{% endif %}"
                >
                  {{ kasa_bakiyesi|floatformat:2|intcomma }} ₺
                </div>
                <div class="label">Kasa Bakiyesi</div>
              </div>
            </div>
          </div>

          <ul class="nav nav-pills mb-3" id="pills-tab" role="tablist">
            <li class="nav-item" role="presentation">
              <button
                class="nav-link active"
                id="pills-aidatlar-tab"
                data-bs-toggle="pill"
                data-bs-target="#pills-aidatlar"
                type="button"
                role="tab"
                aria-controls="pills-aidatlar"
                aria-selected="true"
              >
                Aidat Listesi
              </button>
            </li>
            <li class="nav-item" role="presentation">
              <button
                class="nav-link"
                id="pills-giderler-tab"
                data-bs-toggle="pill"
                data-bs-target="#pills-giderler"
                type="button"
                role="tab"
                aria-controls="pills-giderler"
                aria-selected="false"
              >
                Gider Listesi
              </button>
            </li>
          </ul>
          <div class="tab-content" id="pills-tabContent">
            <div
              class="tab-pane fade show active"
              id="pills-aidatlar"
              role="tabpanel"
              aria-labelledby="pills-aidatlar-tab"
            >
              <h5 style="color: var(--theme-dark-purple); margin-bottom: 1rem;">Aidat Takip Listesi</h5> {# Başlık rengi ve boşluk #}
              <div class="table-responsive equal-height">
                <table
                  class="table table-bordered table-striped table-hover equal-cols"
                  style="margin-bottom: 0"
                >
                  <thead
                    style="
                      position: sticky;
                      top: 0;
                      background: var(--theme-primary-purple); /* HTML İÇİNDEKİ BU SATIRI DEĞİŞTİRİN */
                      color: #fff;
                      z-index: 2;
                    "
                  >
                    <tr>
                      <th>B-D</th>
                      <th>Sakin</th>
                      <th>Yıllık Borç</th>
                      <th>Ödenen</th>
                      <th>Bakiye</th>
                    </tr>
                  </thead>
                  <tbody>
                    {% for d in aidat_ozet %}
                    <tr>
                      <td>{{ d.blok }}-{{ d.daire_no }}</td>
                      <td>{{ d.sakin }}</td>
                      <td>{{ d.yillik_borc|floatformat:2|intcomma }} ₺</td>
                      <td>{{ d.odenen|floatformat:2|intcomma }} ₺</td>
                      <td class="fw-bold 
                        {% if d.bakiye > 0 %}text-danger{% elif d.bakiye < 0 %}text-success{% else %}text-muted{% endif %}">
                        {# Bakiye renklendirmesi Bootstrap sınıflarıyla güncellendi #}
                        {% if d.bakiye > 0 %}-{{ d.bakiye|floatformat:2|intcomma }} ₺ 
                        {% elif d.bakiye < 0 %}+{{ d.bakiye|floatformat:2|intcomma|slice:'1:' }} ₺ 
                        {% else %}0 ₺{% endif %}
                      </td>
                    </tr>
                    {% empty %}
                    <tr>
                      <td colspan="5" class="text-center">
                        Kayıtlı daire yok.
                      </td>
                    </tr>
                    {% endfor %}
                  </tbody>
                </table>
              </div>
            </div>
            <div
              class="tab-pane fade"
              id="pills-giderler"
              role="tabpanel"
              aria-labelledby="pills-giderler-tab"
            >
              <h5 style="color: var(--theme-dark-purple); margin-bottom: 1rem;">Gider Takip Listesi</h5> {# Başlık rengi ve boşluk #}
              <div class="table-responsive equal-height">
                <table
                  class="table table-bordered table-striped table-hover equal-cols"
                  style="margin-bottom: 0"
                >
                  <thead
                    style="
                      position: sticky;
                      top: 0;
                      background: var(--theme-primary-purple); /* HTML İÇİNDEKİ BU SATIRI DEĞİŞTİRİN */
                      color: #fff;
                      z-index: 2;
                    "
                  >
                    <tr>
                      <th>Tarih</th>
                      <th>Tür</th>
                      <th>Tutar</th>
                      <th>Açıklama</th>
                    </tr>
                  </thead>
                  <tbody>
                    {% for gider in giderler %}
                    <tr>
                      <td>{{ gider.tarih|date:"d M Y" }}</td>
                      <td>{{ gider.tur }}</td>
                      <td>{{ gider.tutar|floatformat:2|intcomma }} ₺</td>
                      <td>{{ gider.aciklama|default:"-" }}</td>
                    </tr>
                    {% endfor %} 
                    
                    {% for _ in gider_bos_satir_sayisi %}
                    <tr>
                      <td>&nbsp;</td>
                      <td></td>
                      <td></td>
                      <td></td>
                    </tr>
                    {% endfor %} {% if giderler|length == 0 %}
                    <tr>
                      <td colspan="4" class="text-center">
                        Kayıtlı gider yok.
                      </td>
                    </tr>
                    {% endif %}
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  </body>
</html>